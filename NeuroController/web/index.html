<!DOCTYPE html>
<html lang="en">
<head>
	<meta http-equiv="X-UA-Compatible" content="IE=edge" />
	<title>Home</title>
	<meta content='width=device-width, initial-scale=1.0, shrink-to-fit=no' name='viewport' />
	<link rel="icon" href="assets/img/icon.ico" type="image/x-icon"/>

	<!-- Fonts and icons -->
	<script src="assets/js/plugin/webfont/webfont.min.js"></script>
	<script>
		WebFont.load({
			google: {"families":["Lato:300,400,700,900"]},
			custom: {"families":["Flaticon", "Font Awesome 5 Solid", "Font Awesome 5 Regular", "Font Awesome 5 Brands", "simple-line-icons"], urls: ['assets/css/fonts.min.css']},
			active: function() {
				sessionStorage.fonts = true;
			}
		});
	</script>

	<!-- CSS Files -->
	<link rel="stylesheet" href="assets/css/bootstrap.min.css">
	<link rel="stylesheet" href="assets/css/atlantis.min.css">

	<!-- CSS Just for demo purpose, don't include it in your project -->
	<link rel="stylesheet" href="assets/css/demo.css">
</head>
<body>
	<div class="wrapper">
		<div class="main-header">
			<!-- å›¾è¡¨å¤´ -->
			<div class="logo-header" data-background-color="blue">
				
				<a href="index.html" class="logo">
					<img src="assets/img/logo.svg" alt="navbar brand" class="navbar-brand">
				</a>
				<button class="navbar-toggler sidenav-toggler ml-auto" type="button" data-toggle="collapse" data-target="collapse" aria-expanded="false" aria-label="Toggle navigation">
					<span class="navbar-toggler-icon">
						<i class="icon-menu"></i>
					</span>
				</button>
				<button class="topbar-toggler more"><i class="icon-options-vertical"></i></button>
				<div class="nav-toggle">
					<button class="btn btn-toggle toggle-sidebar">
						<i class="icon-menu"></i>
					</button>
				</div>
			</div>
			<!-- å›¾è¡¨åº• -->
			
			<!-- æ£€ç´¢æ é¡¶éƒ¨ -->
			<nav class="navbar navbar-header navbar-expand-lg" data-background-color="blue2">
				<nav class="navbar navbar-header navbar-expand-lg py-1 px-3" data-background-color="blue2">
					<div class="text-white font-weight-bold">
						Kubernetes æ§åˆ¶å° - é›†ç¾¤çŠ¶æ€å®æ—¶æ¦‚è§ˆ
					</div>
				</nav>
			</nav>
			<!-- æ£€ç´¢æ é¡¶éƒ¨ -->
		</div>

		<!-- å¯¼èˆªæ é¡¶éƒ¨ -->
		<div class="sidebar sidebar-style-2">			
			<div class="sidebar-wrapper scrollbar scrollbar-inner">
				<div class="sidebar-content">
					<div class="user">
						<div class="avatar-sm float-left mr-2">
							<img src="assets/img/profile.jpg" alt="..." class="avatar-img rounded-circle">
						</div>
						<div class="info">
							<a data-toggle="collapse" href="#collapseExample" aria-expanded="true">
								<span>
									Wuxiafeng
									<span class="user-level">æˆ‘çš„é›†ç¾¤</span>
									<span class="caret"></span>
								</span>
							</a>
							<div class="clearfix"></div>

							<div class="collapse in" id="collapseExample">
								<ul class="nav">
									<li>
										<a href="#profile">
											<span class="link-collapse">åˆ‡æ¢</span>
										</a>
									</li>
								</ul>
							</div>
						</div>
					</div>
					<ul class="nav nav-primary">
						<li class="nav-item active">
							<a data-toggle="collapse" href="#dashboard" class="collapsed" aria-expanded="false">
								<i class="fas fa-home"></i>
								<p>K8sDashboard</p>
								<span class="caret"></span>
							</a>
							<div class="collapse" id="dashboard">
								<ul class="nav nav-collapse">
									<li>
										<a href="index.html">
											<span class="sub-item">K8sDashboard</span>
										</a>
									</li>

								</ul>
							</div>
						</li>
						<li class="nav-section">
							<span class="sidebar-mini-icon">
								<i class="fa fa-ellipsis-h"></i>
							</span>
							<h4 class="text-section">Components</h4>
						</li>
						<li class="nav-item">
							<a data-toggle="collapse" href="#base">
								<i class="fas fa-layer-group"></i>
								<p>ç›‘æ§</p>
								<span class="caret"></span>
							</a>
							<div class="collapse" id="base">
								<ul class="nav nav-collapse">
									<li>
										<a href="Pod.html">
											<span class="sub-item">Pod</span>
										</a>
									</li>
									<li>
										<a href="node.html">
											<span class="sub-item">node</span>
										</a>
									</li>
									<li>
										<a href="service.html">
											<span class="sub-item">service</span>
										</a>
									</li>

									<li>
										<a href="namespace.html">
											<span class="sub-item">namespace</span>
										</a>
									</li>
									<li>
										<a href="ingress.html">
											<span class="sub-item">ingress</span>
										</a>
									</li>

									<li>
										<a href="deployment.html">
											<span class="sub-item">deployment</span>
										</a>
									</li>

								</ul>
							</div>
						</li>
						<li class="nav-item">
							<a data-toggle="collapse" href="#sidebarLayouts">
								<i class="fas fa-th-list"></i>
								<p>æ“ä½œ</p>
								<span class="caret"></span>
							</a>
							<div class="collapse" id="sidebarLayouts">
								<ul class="nav nav-collapse">
									<li>
										<a href="create.html">
											<span class="sub-item">èµ„æºåˆ›å»º</span>
										</a>
									</li>

								</ul>
							</div>
						</li>
						<li class="nav-item">
							<a data-toggle="collapse" href="#collapse-exception">
								<i class="fas fa-pen-square"></i>
								<p>å¼‚å¸¸</p>
								<span class="caret"></span>
							</a>
								<div class="collapse" id="collapse-exception">
									<ul class="nav nav-collapse">
									<li>
										<a href="eventlog.html">
										<span class="sub-item">é›†ç¾¤å¼‚å¸¸æ—¥å¿—</span>
										</a>
									</li>
									<li>
										<a href="alertSettings.html">
										<span class="sub-item">å‘Šè­¦ç³»ç»Ÿé…ç½®</span>
										</a>
									</li>
									</ul>
								</div>
						</li>


						<li class="nav-item">
							<a href="widgets.html">
								<i class="fas fa-desktop"></i>
								<p>å¡ç‰‡ä»“åº“</p>
								<span class="badge badge-success">4</span>
							</a>
						</li>

					</ul>
				</div>
			</div>
		</div>
		<!-- å¯¼èˆªæ åº•éƒ¨ -->

		<div class="main-panel">
			<div class="content">
				<div class="panel-header bg-primary-gradient">
					<div class="page-inner py-5">
						<div class="d-flex align-items-left align-items-md-center flex-column flex-md-row">
							<div>
								<h2 class="text-white pb-2 fw-bold">é›†ç¾¤æ¦‚è¦</h2>
								<h5 class="text-white op-7 mb-2">æ•´ä½“ä¿¡æ¯æ¦‚è¦</h5>
							</div>
							<!-- <div class="ml-md-auto py-2 py-md-0">
								<a href="#" class="btn btn-white btn-border btn-round mr-2">å¤‡ç”¨</a>
								<a href="#" class="btn btn-secondary btn-round">å¤‡ç”¨2</a>
							</div> -->
						</div>
					</div>
				</div>
				<div class="page-inner mt--5">
					<div class="row mt--2">
						<div class="col-md-6">
							<div class="card full-height">
								<div class="card-body">
									<div class="card-title">å±•ç¤ºé›†ç¾¤æ¦‚è¦</div>
									<div class="card-category">Daily information about statistics in system</div>

										<div class="d-flex flex-wrap justify-content-around pb-2 pt-4">
										<div class="px-2 pb-2 text-center">
											<div id="circles-1"></div>
											<h6 class="fw-bold mt-3 mb-0">Ready Nodes</h6>
										</div>
										<div class="px-2 pb-2 text-center">
											<div id="circles-2"></div>
											<h6 class="fw-bold mt-3 mb-0">Ready Pods</h6>
										</div>
										<div class="px-2 pb-2 text-center">
											<div id="k8s-version" style="font-size: 20px; font-weight: bold;"></div>
											<h6 class="fw-bold mt-3 mb-0">Kubernetes Version</h6>
											<div id="metrics-info"></div> <!-- âœ… å¯é€‰æ˜¾ç¤º metrics server çŠ¶æ€ -->
										</div>
										</div>
								</div>
							</div>
						</div>



<div class="col-md-6">
    <div class="card full-height">
        <div class="card-body">
           <div class="card-title" id="log-range-title">æœ€è¿‘ 1 å¤©äº‹ä»¶æ•°</div>
            <div class="row py-3">
                <div class="col-md-4 d-flex flex-column justify-content-around">
                    <!-- æ˜¾ç¤ºæ€»å‘Šè­¦æ•°é‡ -->
                    <div>
                        <h6 class="fw-bold text-uppercase text-success op-8">æ€»å‘Šè­¦æ•°é‡</h6>
                        <h3 class="fw-bold" id="stat-total">--</h3> <!-- å°†æ•°æ®åŠ¨æ€ç»‘å®šåˆ°è¿™é‡Œ -->
                    </div>
                    <!-- æ˜¾ç¤º Critical æ•°é‡ -->
                    <div>
                        <h6 class="fw-bold text-uppercase text-danger op-8">Critical æ•°é‡</h6>
                        <h3 class="fw-bold" id="stat-critical">--</h3> <!-- å°†æ•°æ®åŠ¨æ€ç»‘å®šåˆ°è¿™é‡Œ -->
                    </div>
                </div>
                <div class="col-md-4 d-flex flex-column justify-content-around">
                    <!-- æ˜¾ç¤º Warning æ•°é‡ -->
                    <div>
                        <h6 class="fw-bold text-uppercase text-warning op-8">Warning æ•°é‡</h6>
                        <h3 class="fw-bold" id="stat-warning">--</h3> <!-- å°†æ•°æ®åŠ¨æ€ç»‘å®šåˆ°è¿™é‡Œ -->
                    </div>
                    <!-- æ˜¾ç¤ºèµ„æºç§ç±»æ•°é‡ -->
                    <div>
                        <h6 class="fw-bold text-uppercase text-info op-8">èµ„æºç§ç±»æ•°é‡</h6>
                        <h3 class="fw-bold" id="stat-kinds">--</h3> <!-- å°†æ•°æ®åŠ¨æ€ç»‘å®šåˆ°è¿™é‡Œ -->
                    </div>
                </div>
                <div class="col-md-4">
                    <div id="chart-container">
                        <canvas id="totalIncomeChart"></canvas> <!-- è¿™é‡Œä¿æŒåŸæœ‰å›¾è¡¨çš„å ä½ -->
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>



					</div>


					<div class="row">
					<div class="col-md-12">
						<div class="card">
						<div class="card-header">
							<h4 class="card-title">å¼‚å¸¸å‘Šè­¦æ—¥å¿— ä¸€è§ˆè¡¨</h4>
						</div>
						<div class="card-body">
							<div class="table-responsive">
							<table id="multi-filter-select" class="display table table-striped table-hover">
								<thead>
								<tr>
									<th>åç§°</th>
									<th>å‘½åç©ºé—´</th>
									<th>èµ„æºç±»å‹</th>
									<th>èŠ‚ç‚¹</th>
									<th>ä¸¥é‡ç­‰çº§</th>
									<th>åŸå› </th>
									<th>ä¿¡æ¯</th>
									<th>äº‹ä»¶æ—¶é—´</th>
								</tr>
								</thead>
								<tfoot>
								<tr>
									<th>åç§°</th>
									<th>å‘½åç©ºé—´</th>
									<th>èµ„æºç±»å‹</th>
									<th>èŠ‚ç‚¹</th>
									<th>ä¸¥é‡ç­‰çº§</th>
									<th>åŸå› </th>
									<th>ä¿¡æ¯</th>
									<th>äº‹ä»¶æ—¶é—´</th>
								</tr>
								</tfoot>
								<tbody>
								<tr v-for="log in logs" :key="log.eventTime + log.name">
									<td>{{ log.Name }}</td>
									<td>{{ log.Namespace }}</td>
									<td>{{ log.Kind }}</td>
									<td>{{ log.Node || "â€”" }}</td>
									<td>{{ log.Severity }}</td>
									<td>{{ log.ReasonCode }}</td>
									<td>{{ log.Message }}</td>
									<td>{{ new Date(log.Timestamp).toLocaleString() }}</td>
								</tr>
								</tbody>
							</table>
							</div>
						</div>
						</div>
					</div>
					</div>

					
	</div>
	<!--   Core JS Files   -->
	<script src="assets/js/core/jquery.3.2.1.min.js"></script>
	<script src="assets/js/core/popper.min.js"></script>
	<script src="assets/js/core/bootstrap.min.js"></script>

	<!-- jQuery UI -->
	<script src="assets/js/plugin/jquery-ui-1.12.1.custom/jquery-ui.min.js"></script>
	<script src="assets/js/plugin/jquery-ui-touch-punch/jquery.ui.touch-punch.min.js"></script>

	<!-- jQuery Scrollbar -->
	<script src="assets/js/plugin/jquery-scrollbar/jquery.scrollbar.min.js"></script>


	<!-- Chart JS -->
	 <!-- âœ… 1. å…ˆåŠ è½½ Circles åº“ -->
<script src="js/circles.js"></script>

<script src="js/api_config.js"></script>

<script src="js/dashboard.js"></script>

	<!-- <script src="assets/js/plugin/chart.js/chart.min.js"></script> -->

	<!-- jQuery Sparkline -->
	<script src="assets/js/plugin/jquery.sparkline/jquery.sparkline.min.js"></script>

	<!-- Chart Circle -->
	<script src="assets/js/plugin/chart-circle/circles.min.js"></script>

	<!-- Datatables -->
	<script src="assets/js/plugin/datatables/datatables.min.js"></script>

	<!-- Bootstrap Notify -->
	<script src="assets/js/plugin/bootstrap-notify/bootstrap-notify.min.js"></script>

	<!-- jQuery Vector Maps -->
	<script src="assets/js/plugin/jqvmap/jquery.vmap.min.js"></script>
	<script src="assets/js/plugin/jqvmap/maps/jquery.vmap.world.js"></script>

	<!-- Sweet Alert -->
	<script src="assets/js/plugin/sweetalert/sweetalert.min.js"></script>

	<!-- Atlantis JS -->
	<script src="assets/js/atlantis.min.js"></script>

	<!-- Atlantis DEMO methods, don't include it in your project! -->
	<script src="assets/js/setting-demo.js"></script>
	<script src="assets/js/demo.js"></script>
	<script src="js/realtime_refresher.js"></script>


<script src="js/realtime_refresher.js"></script>

<script>
  const stats = {
    totalLogs: 0,
    criticalCount: 0,
    warningCount: 0,
    uniqueKinds: 0
  };

  const safe = val => (val === undefined || val === null ? "â€”" : val);

  function updateCards() {
    document.getElementById('stat-total').textContent = stats.totalLogs;
    document.getElementById('stat-critical').textContent = stats.criticalCount;
    document.getElementById('stat-warning').textContent = stats.warningCount;
    document.getElementById('stat-kinds').textContent = stats.uniqueKinds;
  }

  function updateLogTitle(days) {
    const title = document.getElementById('log-range-title');
    if (title) {
      title.textContent = `æœ€è¿‘ ${days} å¤©äº‹ä»¶æ•°`;
    }
  }

  function rebuildFootFilters(tableApi) {
    tableApi.columns().every(function () {
      const column = this;
      const select = $('<select class="form-control"><option value=""></option></select>')
        .appendTo($(column.footer()).empty())
        .on('change', function () {
          const val = $.fn.dataTable.util.escapeRegex($(this).val());
          column.search(val ? '^' + val + '$' : '', true, false).draw();
        });

      column.data().unique().sort().each(function (d) {
        const clean = $('<div>').html(d).text();
        select.append('<option value="' + clean + '">' + clean + '</option>');
      });
    });
  }

  document.addEventListener("DOMContentLoaded", () => {
    const defaultDays = 1;
    let currentDays = defaultDays;

    function renderLogs(logs) {
      stats.totalLogs = logs.length;
      stats.criticalCount = logs.filter(l => l.severity === "critical").length;
      stats.warningCount = logs.filter(l => l.severity === "warning").length;
      stats.uniqueKinds = [...new Set(logs.map(l => l.kind))].length;
      updateCards();

      const tableId = '#multi-filter-select';
      const tableData = logs.map(log => [
        log.name,
        log.namespace,
        log.kind,
        log.node,
        log.severity,
        log.ReasonCode,
        log.message,
        log.timestamp ? new Date(log.timestamp).toLocaleString() : "â€”"
      ]);

      if ($.fn.dataTable.isDataTable(tableId)) {
        const table = $(tableId).DataTable();
        table.clear();
        table.rows.add(tableData).draw();
        rebuildFootFilters(table);
      } else {
        $(tableId).DataTable({
          pageLength: 10,
          data: tableData,
          columns: [
            { title: "åç§°" },
            { title: "å‘½åç©ºé—´" },
            { title: "èµ„æºç±»å‹" },
            { title: "èŠ‚ç‚¹" },
            { title: "ä¸¥é‡ç­‰çº§" },
            { title: "åŸå› " },
            { title: "ä¿¡æ¯" },
            { title: "äº‹ä»¶æ—¶é—´" }
          ],
          initComplete: function () {
            rebuildFootFilters(this.api());
            setupDaysSelector(currentDays);
          }
        });
      }
    }

    function setupDaysSelector(days) {
      const filterDiv = $('#multi-filter-select_filter');
      filterDiv.html(`
        <label>æœ€è¿‘ 
          <select id="log-days-selector" class="form-control input-sm" style="width:auto;display:inline-block;margin:0 5px;">
            <option value="1">1 å¤©</option>
            <option value="2">2 å¤©</option>
            <option value="3">3 å¤©</option>
            <option value="4">4 å¤©</option>
            <option value="5">5 å¤©</option>
            <option value="6">6 å¤©</option>
            <option value="7">7 å¤©</option>
          </select> å†…æ—¥å¿—</label>
      `);

      document.getElementById('log-days-selector').value = days;

      document.getElementById('log-days-selector').addEventListener('change', e => {
        const selectedDays = parseInt(e.target.value);
        currentDays = selectedDays;
        updateLogTitle(currentDays);
        fetchOnceAndRender(currentDays);
      });
    }

    function fetchOnceAndRender(days) {
      updateLogTitle(days);
	  const apiUrl = API_ENDPOINTS.event.listRecent(days);
      console.log("ğŸ“¡ æ­£åœ¨è¯·æ±‚å¼‚å¸¸äº‹ä»¶æ—¥å¿—æ¥å£ï¼š", apiUrl); 
	  
      fetch(API_ENDPOINTS.event.listRecent(days))
        .then(res => res.json())
        .then(data => {
          const logs = (data.logs || []).map(log => ({
            name: safe(log.Name),
            namespace: safe(log.Namespace),
            kind: safe(log.Kind),
            node: safe(log.Node),
            severity: safe((log.Severity || "").toLowerCase()),
            ReasonCode: safe(log.ReasonCode),
            message: safe(log.Message),
            timestamp: log.Timestamp || log.eventTime || log.time || ""
          }));
          renderLogs(logs);
        })
        .catch(err => {
          console.error("è·å–å¼‚å¸¸å‘Šè­¦æ—¥å¿—å¤±è´¥:", err);
          alert("åç«¯æ¥å£å¼‚å¸¸ï¼Œæ— æ³•åŠ è½½å¼‚å¸¸æ—¥å¿—æ•°æ®ã€‚");
        });
    }

    // âœ… é¡µé¢é¦–æ¬¡åŠ è½½
    fetchOnceAndRender(currentDays);

    // âœ… å¯åŠ¨å®æ—¶åˆ·æ–°ï¼ˆæ¯ 10 ç§’ï¼‰
    const refresher = new RealtimeRefresher({
      fetchFunc: () => {
        return fetch(API_ENDPOINTS.event.listRecent(currentDays))
          .then(res => res.json())
          .then(data => (data.logs || []).map(log => ({
            name: safe(log.Name),
            namespace: safe(log.Namespace),
            kind: safe(log.Kind),
            node: safe(log.Node),
            severity: safe((log.Severity || "").toLowerCase()),
            ReasonCode: safe(log.ReasonCode),
            message: safe(log.Message),
            timestamp: log.Timestamp || log.eventTime || log.time || ""
          })));
      },
      interval: 10000, // ğŸ” æ¯ 10 ç§’è‡ªåŠ¨åˆ·æ–°
      hashFunc: logs => JSON.stringify(logs.map(l => l.timestamp + l.name)).slice(0, 500),
      onChange: renderLogs
    });

    refresher.start();
  });
</script>




</body>
</html>