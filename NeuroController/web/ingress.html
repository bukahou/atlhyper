<!DOCTYPE html>
<html lang="en">
<head>
	<meta http-equiv="X-UA-Compatible" content="IE=edge" />
	<title>Tables - Atlantis Lite Bootstrap 4 Admin Dashboard</title>
	<meta content='width=device-width, initial-scale=1.0, shrink-to-fit=no' name='viewport' />
	<link rel="icon" href="assets/img/icon.ico" type="image/x-icon"/>

	<!-- Fonts and icons -->
	<script src="assets/js/plugin/webfont/webfont.min.js"></script>
	<script>
		WebFont.load({
			google: {"families":["Lato:300,400,700,900"]},
			custom: {"families":["Flaticon", "Font Awesome 5 Solid", "Font Awesome 5 Regular", "Font Awesome 5 Brands", "simple-line-icons"], urls: ['assets/css/fonts.min.css']},
			active: function() {
				sessionStorage.fonts = true;
			}
		});
	</script>

	<!-- CSS Files -->
	<link rel="stylesheet" href="assets/css/bootstrap.min.css">
	<link rel="stylesheet" href="assets/css/atlantis.min.css">
	<!-- CSS Just for demo purpose, don't include it in your project -->
	<link rel="stylesheet" href="assets/css/demo.css">
</head>
<body>
	<div id="app">
	<div class="wrapper">
		<div class="main-header">
			
			<!-- 图表头 -->
			<div class="logo-header" data-background-color="blue">
				
				<a href="index.html" class="logo">
					<img src="assets/img/logo.svg" alt="navbar brand" class="navbar-brand">
				</a>
				<button class="navbar-toggler sidenav-toggler ml-auto" type="button" data-toggle="collapse" data-target="collapse" aria-expanded="false" aria-label="Toggle navigation">
					<span class="navbar-toggler-icon">
						<i class="icon-menu"></i>
					</span>
				</button>
				<button class="topbar-toggler more"><i class="icon-options-vertical"></i></button>
				<div class="nav-toggle">
					<button class="btn btn-toggle toggle-sidebar">
						<i class="icon-menu"></i>
					</button>
				</div>
			</div>
			<!-- 图表底 -->
			
			<!-- 检索栏顶部 -->
			<nav class="navbar navbar-header navbar-expand-lg" data-background-color="blue2">
				
				<nav class="navbar navbar-header navbar-expand-lg py-1 px-3" data-background-color="blue2">
					<div class="text-white font-weight-bold">
						Kubernetes 控制台 - 集群状态实时概览
					</div>
				</nav>
			</nav>
			<!-- 检索栏顶部 -->
			
		</div>

		<!-- 导航栏顶部 -->
		<div class="sidebar sidebar-style-2">			
			<div class="sidebar-wrapper scrollbar scrollbar-inner">
				<div class="sidebar-content">
					<div class="user">
						<div class="avatar-sm float-left mr-2">
							<img src="assets/img/profile.jpg" alt="..." class="avatar-img rounded-circle">
						</div>
						<div class="info">
							<a data-toggle="collapse" href="#collapseExample" aria-expanded="true">
								<span>
									Wuxiafeng
									<span class="user-level">我的集群</span>
									<span class="caret"></span>
								</span>
							</a>
							<div class="clearfix"></div>

							<div class="collapse in" id="collapseExample">
								<ul class="nav">
									<li>
										<a href="#profile">
											<span class="link-collapse">切换</span>
										</a>
									</li>
								</ul>
							</div>
						</div>
					</div>
					<ul class="nav nav-primary">
						<li class="nav-item active">
							<a data-toggle="collapse" href="#dashboard" class="collapsed" aria-expanded="false">
								<i class="fas fa-home"></i>
								<p>K8sDashboard</p>
								<span class="caret"></span>
							</a>
							<div class="collapse" id="dashboard">
								<ul class="nav nav-collapse">
									<li>
										<a href="index.html">
											<span class="sub-item">K8sDashboard</span>
										</a>
									</li>

								</ul>
							</div>
						</li>
						<li class="nav-section">
							<span class="sidebar-mini-icon">
								<i class="fa fa-ellipsis-h"></i>
							</span>
							<h4 class="text-section">Components</h4>
						</li>
						<li class="nav-item">
							<a data-toggle="collapse" href="#base">
								<i class="fas fa-layer-group"></i>
								<p>监控</p>
								<span class="caret"></span>
							</a>
							<div class="collapse" id="base">
								<ul class="nav nav-collapse">
									<li>
										<a href="Pod.html">
											<span class="sub-item">Pod</span>
										</a>
									</li>
									<li>
										<a href="node.html">
											<span class="sub-item">node</span>
										</a>
									</li>
									<li>
										<a href="service.html">
											<span class="sub-item">service</span>
										</a>
									</li>

									<li>
										<a href="namespace.html">
											<span class="sub-item">namespace</span>
										</a>
									</li>
									<li>
										<a href="ingress.html">
											<span class="sub-item">ingress</span>
										</a>
									</li>
									

									<li>
										<a href="deployment.html">
											<span class="sub-item">deployment</span>
										</a>
									</li>



								</ul>
							</div>
						</li>
						<li class="nav-item">
							<a data-toggle="collapse" href="#sidebarLayouts">
								<i class="fas fa-th-list"></i>
								<p>操作</p>
								<span class="caret"></span>
							</a>
							<div class="collapse" id="sidebarLayouts">
								<ul class="nav nav-collapse">
									<li>
										<a href="create.html">
											<span class="sub-item">资源创建</span>
										</a>
									</li>

								</ul>
							</div>
						</li>
						<li class="nav-item">
							<a data-toggle="collapse" href="#forms">
								<i class="fas fa-pen-square"></i>
								<p>异常</p>
								<span class="caret"></span>
							</a>
							<div class="collapse" id="forms">
								<ul class="nav nav-collapse">
									<li>
										<a href="eventlog.html">
											<span class="sub-item">集群告警</span>
										</a>
									</li>
								</ul>
							</div>
						</li>

						<li class="nav-item">
							<a href="widgets.html">
								<i class="fas fa-desktop"></i>
								<p>卡片仓库</p>
								<span class="badge badge-success">4</span>
							</a>
						</li>

					</ul>
				</div>
			</div>
		</div>
		<!-- 导航栏底部 -->


		<div class="main-panel">
		<div class="content">
			<div class="page-inner">
			<!-- 标题 -->
			<h4 class="page-title">Ingress 总览</h4>

			<!-- 卡片区域（使用 v-for 渲染） -->
				<div class="row" id="node-summary-cards">
					<div class="col-sm-6 col-md-3" v-for="card in cards" :key="card.title">
						<div class="card" :class="card.class">
						<div class="card-body">
							<div class="row">
							<div class="col-5">
								<div class="icon-big text-center">
								<i :class="card.icon"></i>
								</div>
							</div>
							<div class="col-7 col-stats">
								<div class="numbers">
								<p class="card-category">{{ card.title }}</p>
								<h4 class="card-title">{{ card.value }}</h4>
								</div>
							</div>
							</div>
						</div>
						</div>
					</div>
				</div>


			<!-- 表格区域 -->
					<div class="row">
						<div class="col-md-12">
							<div class="card">
								<div class="card-header">
									<h4 class="card-title">Ingress 一览表</h4>
								</div>
								<div class="card-body">
									<div class="table-responsive">
										<table id="multi-filter-select" class="display table table-striped table-hover">
											<thead>
												<tr>
													<th>名称</th>
													<th>命名空间</th>
													<th>域名 Host</th>
													<th>路由路径</th>
													<th>服务名</th>
													<th>服务端口</th>
													<th>使用 TLS</th>
													<th>创建时间</th>
												</tr>
											</thead>
											<tfoot>
												<tr>
													<th>名称</th>
													<th>命名空间</th>
													<th>域名 Host</th>
													<th>路由路径</th>
													<th>服务名</th>
													<th>服务端口</th>
													<th>使用 TLS</th>
													<th>创建时间</th>
												</tr>
											</tfoot>
											<tbody>
												<tr v-for="item in ingresses" :key="item.name + '_' + item.namespace">
													<td>{{ item.name }}</td>
													<td>{{ item.namespace }}</td>
													<td>{{ item.hosts }}</td>
													<td>{{ item.paths }}</td>
													<td>{{ item.serviceNames }}</td>
													<td>{{ item.ports }}</td>
													<td>{{ item.tls || "—" }}</td>
													<td>{{ item.creationTime }}</td>
												</tr>
											</tbody>
										</table>
									</div>
								</div>
							</div>
						</div>
					</div>




				</div>
			</div>
		</div>
	</div>
	<!--   Core JS Files   -->
	<script src="js/vue.min.js"></script>

	<script src="assets/js/core/jquery.3.2.1.min.js"></script>
	<script src="assets/js/core/popper.min.js"></script>
	<script src="assets/js/core/bootstrap.min.js"></script>
	<!-- jQuery UI -->
	<script src="assets/js/plugin/jquery-ui-1.12.1.custom/jquery-ui.min.js"></script>
	<script src="assets/js/plugin/jquery-ui-touch-punch/jquery.ui.touch-punch.min.js"></script>

	<!-- jQuery Scrollbar -->
	<script src="assets/js/plugin/jquery-scrollbar/jquery.scrollbar.min.js"></script>
	<!-- Datatables -->
	<script src="assets/js/plugin/datatables/datatables.min.js"></script>
	<!-- Atlantis JS -->
	<script src="assets/js/atlantis.min.js"></script>
	<!-- Atlantis DEMO methods, don't include it in your project! -->
	<script src="assets/js/setting-demo2.js"></script>
	<script src="js/api_config.js"></script>
<script>
  new Vue({
    el: "#app",
    data: {
      stats: {
        totalIngresses: "--",
        uniqueHosts: "--",
        uniqueTLS: "--",
        totalPaths: "--"
      },
      ingresses: []
    },
    computed: {
      cards() {
        return [
          {
            title: "Ingress 总数",
            value: this.stats.totalIngresses,
            icon: "flaticon-network",
            class: "card-primary card-round"
          },
          {
            title: "使用域名数",
            value: this.stats.uniqueHosts,
            icon: "flaticon-globe",
            class: "card-info card-round"
          },
          {
            title: "TLS 证书数",
            value: this.stats.uniqueTLS,
            icon: "flaticon-lock",
            class: "card-success card-round"
          },
          {
            title: "路由路径总数",
            value: this.stats.totalPaths,
            icon: "flaticon-list",
            class: "card-warning card-round"
          }
        ];
      }
    },
    created() {
      fetch(API_BASE_URL + "/uiapi/ingress/list/all")
        .then(res => res.json())
        .then(data => {
          this.ingresses = data.map(item => {
            const hosts = [];
            const paths = [];
            const services = [];
            const ports = [];

            if (item.spec && item.spec.rules) {
              item.spec.rules.forEach(rule => {
                const host = rule.host || "-";
                hosts.push(host);
                if (rule.http && rule.http.paths) {
                  rule.http.paths.forEach(p => {
                    paths.push(p.path || "/");
                    services.push(p.backend?.service?.name || "—");
                    ports.push(p.backend?.service?.port?.number || p.backend?.service?.port?.name || "—");
                  });
                }
              });
            }

            const tlsUsed = item.spec?.tls?.length > 0
              ? item.spec.tls.map(t => t.hosts.join(",")).join("; ")
              : "—";

            return {
              name: item.metadata.name,
              namespace: item.metadata.namespace,
              hosts: hosts.join(", "),
              paths: paths.join(", "),
              serviceNames: services.join(", "),
              ports: ports.join(", "),
              tls: tlsUsed,
              creationTime: new Date(item.metadata.creationTimestamp).toLocaleString()
            };
          });

          const total = this.ingresses.length;
          const allHosts = data.flatMap(ing => ing.spec?.rules?.map(r => r.host) || []);
          const allTLS = data.flatMap(ing => (ing.spec?.tls || []).map(t => t.secretName));
          const totalPaths = data.reduce((sum, ing) => {
            return sum + (ing.spec?.rules?.flatMap(r => r.http?.paths || []).length || 0);
          }, 0);

          this.stats = {
            totalIngresses: total,
            uniqueHosts: [...new Set(allHosts)].length,
            uniqueTLS: [...new Set(allTLS)].length,
            totalPaths: totalPaths
          };

          this.$nextTick(() => {
            const table = $('#multi-filter-select').DataTable({
              pageLength: 10
            });

            table.columns().every(function () {
              const column = this;
              const select = $('<select class="form-control"><option value=""></option></select>')
                .appendTo($(column.footer()).empty())
                .on('change', function () {
                  const val = $.fn.dataTable.util.escapeRegex($(this).val());
                  column.search(val ? '^' + val + '$' : '', true, false).draw();
                });

              column.data().unique().sort().each(function (d) {
                const clean = $('<div>').html(d).text(); // 防止 HTML 干扰
                select.append('<option value="' + clean + '">' + clean + '</option>');
              });
            });
          });
        })
        .catch(err => {
          console.error("获取 Ingress 数据失败:", err);
          alert("后端服务异常，无法加载 Ingress 数据。");
        });
    }
  });
</script>


</body>
</html>