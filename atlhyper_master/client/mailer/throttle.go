package mailer

import (
	"AtlHyper/model/integration"
	"sync"
	"time"
)

// ===================================================================================
// ğŸ§  èŠ‚æµæ§åˆ¶æœºåˆ¶ - é˜²æ­¢é‚®ä»¶é¢‘ç¹å‘é€
//
// ä½¿ç”¨äº’æ–¥é”å’Œæ—¶é—´è®°å½•ï¼Œç¡®ä¿ä»»æ„æ—¶é—´æ®µå†…åªå‘é€ä¸€æ¬¡é‚®ä»¶ã€‚
// å¯é¿å…å› çŸ­æ—¶é—´å†…é‡å¤è§¦å‘å‘Šè­¦è€Œå¯¼è‡´é‚®ä»¶è½°ç‚¸ã€‚
// ===================================================================================

// ğŸ§  å…¨å±€äº’æ–¥é”å’Œè®°å½•å˜é‡ï¼ˆå¿…é¡»å¹¶å‘å®‰å…¨ï¼‰
var (
	lastEmailSentTimeMu sync.Mutex // âœ… ç”¨äºä¿æŠ¤ lastEmailSentTime çš„å¹¶å‘è®¿é—®
	lastEmailSentTime   time.Time  // âœ… ä¸Šä¸€æ¬¡å‘é€é‚®ä»¶çš„æ—¶é—´æˆ³
)

// â± èŠ‚æµæ—¶é—´é—´éš”ï¼ˆè®¾ç½®ä¸º 1 å°æ—¶ï¼‰
//     - ä½œç”¨ï¼šè‹¥è·ç¦»ä¸Šæ¬¡å‘é€ä¸è¶³ 1 å°æ—¶ï¼Œå°†è·³è¿‡é‚®ä»¶å‘é€
const throttleInterval = 1 * time.Hour

// ===================================================================================
// âœ… SendAlertEmailWithThrottle - èŠ‚æµåˆ¤æ–­åå‘é€å‘Šè­¦é‚®ä»¶
//
// å¤–éƒ¨ç»Ÿä¸€è°ƒç”¨æ­¤å‡½æ•°å‘é€é‚®ä»¶ï¼Œä¼šè‡ªåŠ¨åˆ¤æ–­æ˜¯å¦æ»¡è¶³èŠ‚æµæ¡ä»¶ã€‚
//     - è‹¥å¤„äºå†·å´æœŸå†…ï¼šç›´æ¥è·³è¿‡ï¼Œä¸å‘é€
//     - è‹¥è¶…å‡ºå†·å´æœŸï¼šè°ƒç”¨ SendAlertEmail çœŸæ­£å‘é€é‚®ä»¶ï¼Œå¹¶è®°å½•æ—¶é—´
//
// å‚æ•°ï¼š
//     - to         æ”¶ä»¶äººåˆ—è¡¨ï¼ˆå¦‚ ["admin@example.com"]ï¼‰
//     - subject    é‚®ä»¶æ ‡é¢˜ï¼ˆå¦‚ "èŠ‚ç‚¹å¼‚å¸¸å‘Šè­¦"ï¼‰
//     - data       å‘Šè­¦å†…å®¹ç»“æ„ä½“ï¼Œå°†ç”¨äºæ¸²æŸ“ HTML æ¨¡æ¿
//     - eventTime  å‘Šè­¦è§¦å‘äº‹ä»¶çš„æ—¶é—´ï¼ˆæš‚æœªç”¨äºé€»è¾‘åˆ¤æ–­ï¼‰
//
// è¿”å›ï¼š
//     - error      è‹¥é‚®ä»¶å‘é€å¤±è´¥åˆ™è¿”å›é”™è¯¯ï¼Œå¦åˆ™ä¸º nil
// ===================================================================================
func SendAlertEmailWithThrottle(to []string, subject string, data integration.AlertGroupData, eventTime time.Time) error {
	// âœ… åŠ é”ï¼Œç¡®ä¿å¤šåç¨‹ä¸‹ä¸ä¼šé‡å¤å‘é€
	lastEmailSentTimeMu.Lock()
	defer lastEmailSentTimeMu.Unlock()

	// âŒ è‹¥ä¸Šæ¬¡å‘é€æ—¶é—´éé›¶ï¼Œä¸”è·ç¦»å½“å‰ä¸è¶³ throttleIntervalï¼Œåˆ™è·³è¿‡
	if !lastEmailSentTime.IsZero() && time.Since(lastEmailSentTime) < throttleInterval {
		return nil
	}

	// âœ… æ»¡è¶³èŠ‚æµæ¡ä»¶ï¼šæ›´æ–°è®°å½•æ—¶é—´ï¼Œå¹¶å‘é€é‚®ä»¶
	lastEmailSentTime = time.Now()
	return SendAlertEmail(to, subject, data)
}
